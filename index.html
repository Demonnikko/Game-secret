<!-- index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–®–û–£ –°–ï–ö–†–ï–¢ ‚Äî –∏–≥—Ä–∞</title>
  <link rel="preload" as="image" href="images/secret-title.jpg">
  <style>
    :root{
      --bg:#000; --panel:#0b0b0f; --ink:#e9edf5;
      --muted:#9aa3af; --gold1:#ffcf76; --gold2:#e0b44f; --gold3:#a6730c;
      --btn:#e11d48; /* –∫—Ä–∞—Å–Ω–∞—è "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" */
    }
    html,body{height:100%;margin:0;background:#000;color:var(--ink);font:16px/1.55 Inter,system-ui,Segoe UI,Roboto}
    .overlay{position:fixed;inset:0;display:grid;place-items:center;padding:20px;background:rgba(0,0,0,.6)}
    .modal{width:min(92vw,680px);background:#000;border-radius:28px;padding:24px 22px 28px}
    .logo{display:grid;place-items:center;margin:4px 0 18px}
    .logo img{display:block;max-width:360px;width:85%;height:auto}
    .title{margin:0 8px 10px;text-align:center;font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .lead{margin:0 auto 16px;color:#cdd3dd;max-width:46ch;text-align:center}
    .lead b{color:#fff}
    .pills{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0}
    .pill{border:1px solid rgba(255,255,255,.08);color:#cdd3dd;border-radius:999px;padding:10px 14px;font-weight:700}
    .pill.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1207;border:0}
    .actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px}
    .btn{appearance:none;border:0;border-radius:14px;padding:13px 18px;font-weight:800;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
    .btn:active{transform:translateY(1px)}
    .btn-sub{background:var(--btn);color:#fff;box-shadow:0 10px 24px rgba(225,29,72,.25)}
    .btn-go{background:#111827;color:#e5e7eb;border:1px solid rgba(255,255,255,.1)}
    /* ===== –ò–≥—Ä–∞ ===== */
    .game{display:none;max-width:880px;margin:40px auto 80px;padding:20px;border-radius:28px;background:radial-gradient(60% 80% at 50% 0%,rgba(255,207,118,.08),transparent 60%),#08080a}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;place-items:center}
    .card{width:180px;height:260px;border-radius:18px;background:
      linear-gradient(180deg,rgba(255,207,118,.35),rgba(224,180,79,.35)),
      #0b0b0f;border:2px solid #d6b05f;display:grid;place-items:center;position:relative;overflow:hidden}
    .card-face{font-size:64px}
    .selectors{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:18px 0}
    select{width:100%;background:#0f1115;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px}
    .btn-guess{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1207;box-shadow:0 12px 28px rgba(255,207,118,.2)}
    .center{text-align:center}
    .qr-modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);padding:20px}
    .qr-box{background:#0b0b0f;border-radius:20px;padding:18px 18px 22px;width:min(92vw,460px);text-align:center}
    .qr-box img{width:260px;max-width:80%;height:auto}
    .muted{color:#9aa3af}
    @media (max-width:620px){
      .card{width:30vw;height:42vw}
      .logo img{width:92%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
  <!-- –ú–û–î–ê–õ–ö–ê –ü–û–î–ü–ò–°–ö–ò -->
  <div class="overlay" id="welcome">
    <div class="modal">
      <div class="logo"><img src="images/secret-title.jpg" alt="–®–û–£ –°–ï–ö–†–ï–¢"></div>
      <h2 class="title">–®–û–£ –°–ï–ö–†–ï–¢</h2>
      <p class="lead">
        <b>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞.</b> –ß—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∏–≥—Ä—É –∏ –ø–æ–ª—É—á–∏—Ç—å —à–∞–Ω—Å –Ω–∞ —Å–∫–∏–¥–∫—É ‚Äî <b>–ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª</b>,
        –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –ø—Ä–æ–≤–µ—Ä–∏–ª¬ª.
      </p>
      <div class="pills">
        <span class="pill">1 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî 10%</span>
        <span class="pill">2 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Äî 15%</span>
        <span class="pill">3 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Äî 20%</span>
      </div>
      <div class="pills">
        <span class="pill gold">50% —Å–∫–∏–¥–∫–∞</span>
        <span class="pill gold">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∏–ª–µ—Ç</span>
      </div>
      <div class="actions">
        <button class="btn btn-sub" id="btn-sub">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
        <button class="btn btn-go" id="btn-check">–Ø –ø—Ä–æ–≤–µ—Ä–∏–ª ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –∏–≥—Ä–µ</button>
      </div>
    </div>
  </div>

  <!-- –°–ï–ö–¶–ò–Ø –ò–ì–†–´ -->
  <section class="game" id="game">
    <div class="center">
      <div class="logo" style="margin:0 0 6px"><img src="images/secret-title.jpg" alt=""></div>
      <h2 class="title" style="margin:0 0 16px">–£–≥–∞–¥–∞–π 3 –∫–∞—Ä—Ç—ã</h2>
      <p class="muted" style="margin:0 0 18px">–ö–æ–ª–æ–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥. –ù–æ–º–∏–Ω–∞–ª—ã: A, K, Q, J, 10.</p>
    </div>

    <div class="grid" id="cards">
      <div class="card"><div class="card-face">üÇ†</div></div>
      <div class="card"><div class="card-face">üÇ†</div></div>
      <div class="card"><div class="card-face">üÇ†</div></div>
    </div>

    <div class="selectors" id="selectors"></div>

    <div class="center">
      <button class="btn btn-guess" id="btn-guess">–£–≥–∞–¥–∞—Ç—å</button>
    </div>
  </section>

  <!-- –º–æ–¥–∞–ª–∫–∞ —Å QR -->
  <div class="qr-modal" id="qr">
    <div class="qr-box">
      <div class="badge pill gold" style="display:inline-block;margin-bottom:10px">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ</div>
      <h3 class="title" style="margin:0 0 8px">–ö—É–ø–æ–Ω <span id="qrPrize"></span></h3>
      <p class="muted" style="margin:0 0 12px">–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR –Ω–∞ –∫–∞—Å—Å–µ. –ö—É–ø–æ–Ω —É–Ω–∏–∫–∞–ª–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è.</p>
      <img id="qrImg" alt="QR">
      <div class="actions" style="margin-top:14px">
        <a id="qrLink" class="btn btn-go" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a>
        <a id="qrDownload" class="btn btn-guess" href="#" download="coupon-qr.png">–°–∫–∞—á–∞—Ç—å QR</a>
      </div>
      <div class="muted" id="qrNote" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  const TG_CHANNEL = "https://t.me/secretshowow"; // —Ç–≤–æ–π –∫–∞–Ω–∞–ª
  const ranks = ["A","K","Q","J","10"];           // —Ç–æ–ª—å–∫–æ 5 –Ω–æ–º–∏–Ω–∞–ª–æ–≤ (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª)
  const $ = s => document.querySelector(s);

  // ===== –º–æ–¥–∞–ª–∫–∞
  $("#btn-sub").onclick = () => window.open(TG_CHANNEL, "_blank");
  $("#btn-check").onclick = () => {
    $("#welcome").style.display = "none";
    $("#game").style.display = "block";
    resetDeck();
  };

  // ===== –∫–æ–ª–æ–¥–∞/–∏–≥—Ä–∞
  let secret = []; // —Ç—Ä–∏ —Å–µ–∫—Ä–µ—Ç–∞
  let revealTimer;

  function randomRank(){ return ranks[Math.floor(Math.random()*ranks.length)]; }

  function resetDeck(){
    secret = [randomRank(), randomRank(), randomRank()];
    renderSelectors();
    clearTimeout(revealTimer);
    revealTimer = setTimeout(resetDeck, 10000); // –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
  }

  function renderSelectors(){
    const wrap = $("#selectors");
    wrap.innerHTML = "";
    for(let i=0;i<3;i++){
      const sel = document.createElement("select");
      ranks.forEach(r=>{
        const opt = document.createElement("option");
        opt.value = r; opt.textContent = r;
        sel.appendChild(opt);
      });
      wrap.appendChild(sel);
    }
  }

  function confettiBoom(){
    const duration = 1400;
    const end = Date.now() + duration;
    (function frame(){
      confetti({particleCount: 2, angle: 60, spread: 65, origin: {x:0}, scalar:1.2});
      confetti({particleCount: 2, angle: 120, spread: 65, origin: {x:1}, scalar:1.2});
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
    confetti({ particleCount: 280, spread: 140, startVelocity: 45, scalar:1.1, ticks: 180 });
  }

  function flipCards(show){
    const faces = [...document.querySelectorAll(".card .card-face")];
    faces.forEach((f,i) => f.textContent = show ? secret[i] : "üÇ†");
  }

  $("#btn-guess").onclick = async () => {
    const picks = [...document.querySelectorAll("#selectors select")].map(s=>s.value);
    flipCards(true);

    // –ø–æ—Å—á–∏—Ç–∞—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è
    let hits = 0; for(let i=0;i<3;i++){ if(picks[i]===secret[i]) hits++; }

    // –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ ¬´–∫—Ä—É–ø–Ω—ã—Ö¬ª –ø—Ä–∏–∑–æ–≤ (–Ω–∞ –≤–∫—É—Å/—Ü–≤–µ—Ç –º–æ–∂–Ω–æ –ø–æ–¥–∫—Ä—É—Ç–∏—Ç—å):
    let prizeText = null;
    if (hits === 3) prizeText = "–°–∫–∏–¥–∫–∞ 20%";
    else if (hits === 2) prizeText = "–°–∫–∏–¥–∫–∞ 15%";
    else if (hits === 1) prizeText = "–°–∫–∏–¥–∫–∞ 10%";

    // —Ä–∞–Ω–¥–æ–º –¥–æ–ø.–≤—ã–∏–≥—Ä—ã—à–∏:
    const lucky50 = Math.random() < 0.06;  // ~6% —à–∞–Ω—Å
    const luckyFree = Math.random() < 0.02; // ~2% —à–∞–Ω—Å
    if (luckyFree) prizeText = "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∏–ª–µ—Ç";
    else if (lucky50) prizeText = "–°–∫–∏–¥–∫–∞ 50%";

    if (!prizeText) {
      alert("–ß—É—Ç—å-—á—É—Ç—å –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!");
      return;
    }

    // –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –¥–ª—è 50% –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ
    if (prizeText.includes("50%") || prizeText.includes("–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π")) {
      confettiBoom();
      setTimeout(()=>{}, 300);
    }

    // –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø—É—Å–∫ –∫—É–ø–æ–Ω–∞ + QR
    try {
      const res = await fetch("/api/mint", {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({ prize: prizeText })
      });
      if (!res.ok) throw new Error("server");
      const data = await res.json();

      $("#qrPrize").textContent = prizeText;
      $("#qrImg").src = data.qrDataUrl;
      $("#qrLink").href = data.redeemUrl;
      $("#qrDownload").href = data.qrDataUrl;
      $("#qrNote").textContent = `ID: ${data.id}`;
      $("#qr").style.display = "grid";
    } catch(e){
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø—É—Å—Ç–∏—Ç—å –∫—É–ø–æ–Ω. –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –ø–æ –¥–æ–º–µ–Ω—É *.vercel.app (—Ç–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã /api/*).");
    }
  };

  // –∫–ª–∏–∫ –≤–Ω–µ QR ‚Äî –∑–∞–∫—Ä—ã—Ç—å
  $("#qr").addEventListener("click",(e)=>{ if(e.target.id==="qr") $("#qr").style.display="none"; });

  // —Å—Ç–∞—Ä—Ç
  renderSelectors();
</script>
</body>
</html>